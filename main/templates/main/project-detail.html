{% extends 'main/base.html' %}
{% load static %}
{% load i18n %}
{% block content %}
<div class="ui grid container">
    <div class="sixteen wide column">
        <div class="ui piled segments">
            <div class="ui segment">
                <h2 class="ui header">
                    Cats
                </h2>
            </div>
            <div class="ui segment">
                <div class="ui four mini statistics">
                <div class="statistic">
                    <div class="value">
                    22
                    </div>
                    <div class="label">
                    Saves
                    </div>
                </div>
                <div class="statistic">
                    <div class="text value">
                    Three<br>
                    Thousand
                    </div>
                    <div class="label">
                    Signups
                    </div>
                </div>
                <div class="statistic">
                    <div class="value">
                    <i class="plane icon"></i> 5
                    </div>
                    <div class="label">
                    Flights
                    </div>
                </div>
                <div class="statistic">
                    <div class="value">
                    <img src="" class="ui circular inline image">
                    42
                    </div>
                    <div class="label">
                    Team Members
                    </div>
                </div>
                </div>
            </div>

    </div>
    <hr>
    <div class="sixteen wide column">
        <div class="ui raised segments">
            <div class="ui vertical secondary segment">
                <div class="ui floating dropdown labeled icon button">
  <i class="filter icon"></i>
  <span class="text">Filter Posts</span>
  <div class="menu">
    <div class="ui icon search input">
      <i class="search icon"></i>
      <input type="text" placeholder="Search tags...">
    </div>
    <div class="divider"></div>
    <div class="header">
      <i class="tags icon"></i>
      Tag Label
    </div>
    <div class="scrolling menu">
      <div class="item">
        <div class="ui red empty circular label"></div>
        Important
      </div>
      <div class="item">
        <div class="ui blue empty circular label"></div>
        Announcement
      </div>
      <div class="item">
        <div class="ui black empty circular label"></div>
        Cannot Fix
      </div>
      <div class="item">
        <div class="ui purple empty circular label"></div>
        News
      </div>
      <div class="item">
        <div class="ui orange empty circular label"></div>
        Enhancement
      </div>
      <div class="item">
        <div class="ui empty circular label"></div>
        Change Declined
      </div>
      <div class="item">
        <div class="ui yellow empty circular label"></div>
        Off Topic
      </div>
      <div class="item">
        <div class="ui pink empty circular label"></div>
        Interesting
      </div>
      <div class="item">
        <div class="ui green empty circular label"></div>
        Discussion
      </div>
    </div>
  </div>
</div>
            </div>
            <div class="ui segment">
                <p>Middle</p>
            </div>
            <div class="ui segment">
                <p>Middle</p>
            </div>
            <div class="ui segment">
                <p>Middle</p>
            </div>
            <div class="ui segment">
                <p>Bottom</p>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
{% block javascripts %}
<script>
var value = $('.ui.dropdown')
  .dropdown('get value')
;
console.log(value)

</script>


{% endblock javascripts %}




<div class="ui centered stackable grid container">
  <div class="center aligned sixteen wide column">
    <h2 class="brand-title">{% trans "My Projects" %}</h2>
  </div>
  <div class="left floated four wide column">
    <button class="ui primary button rounded-pill">
      {% trans "Create Project" %}
    </button>
  </div>
  <div class="right aligned four wide column">
    <div class="ui search">
      <div class="ui fluid icon input">
        <input class="prompt" type="text" placeholder="Search...">
        <i class="search icon"></i>
      </div>
    </div>
  </div>
</div>
  <table id="myTable" class="ui striped yellow table">
    <thead>
      <tr>
        <th class="one wide"></th>
        <th class="one wide">Tickets</th>
        <th class="seven wide">Title</th>
        <th class="three wide">Create Date</th>
        <th class="two wide">Manager</th>
        <th class="two wide"></th>
      </tr>
    </thead>
    <tbody>
    {% for project in projects %}
      <tr>
      {% if request.user in project.liked.all %}
        <td class="middle aligned content" data-order="0">
          <i role="button"
              class="center aligned ui heart icon red"
              data-value="{{ project.id }}"
              data-url="{% url 'main:project-like-unlike' %}"
              data-bs-toggle="tooltip" data-bs-placement="bottom" title="Remove from favourite">
          </i>
      {% else %}
        <td class="middle aligned content" data-order="1">
          <i role="button"
              class="center aligned ui heart icon outline"
              data-value="{{ project.id }}"
              data-url="{% url 'main:project-like-unlike' %}"
              data-bs-toggle="tooltip" data-bs-placement="bottom" title="Add to favourite">
          </i>
      {% endif %}
        {% csrf_token %}
        </td>
        <td class="middle aligned content">
          <h2 class="ui green center aligned header">{{ project.open_ticket_count }}</h2>
        </td>
        <td class="middle aligned content">{{ project.title }}</td>
        <td class="middle aligned content">{{ project.date_created | date:"j/ N/ Y" }}</td>
        {% if request.user in project.manager.all %}
        <td class="middle aligned content" data-order="0" data-search="{{ request.user.get_full_name }}">
            <a class="ui small button" href="#">
              Manage User
            </a>
        {% else %}
        <td class="middle aligned content" data-order="1" data-search="{{ project.get_manager_name_set }}">
          {% for manager in project.manager.all %}
            <div class="text">
              <img class="ui avatar image" src="{{ manager.profile.image.url }}">
              {{ manager.get_full_name }}
            </div>
          {% endfor %}
        {% endif %}
        </td>
        <td class="middle aligned content">
          <a class="ui small right labeled icon blue button" href="#">
            <i class="right arrow icon"></i>
            Detail
          </a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th></th>
        <th>Tickets</th>
        <th>Title</th>
        <th>Creat Date</th>
        <th>Manager</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

<script>
  $(document).ready( function () {
    // Setup - add a text input to each footer cell
    $('tfoot th').each( function () {
        var title = $(this).text();
        if (title !== '') {
          $(this).html( '<div class="ui mini icon input">'+
                        '<input type="text" placeholder="Search  '+title+'..">'+
                        '<i class="search icon"></i>'+
                        '</div>' );
        }
    } );
    var table = $('#myTable').DataTable({
      initComplete: function () {
        // Apply the search
        this.api().columns().every( function () {
            var that = this;
            $( 'input', this.footer() ).on( 'keyup change clear', function () {
                if ( that.search() !== this.value ) {
                    that
                        .search( this.value )
                        .draw();
                }
            } );
        } );
      },
      dom: "<'ui centered stackable grid container'"+
                "<'sixteen wide column'tr>"+
                "<'left floated three wide column'l>"+
                "<'center aligned four wide column'i>"+
                "<'right aligned nine wide column'p>"+
            ">",

      responsive: true,
      pagingType: "full_numbers",
      order: [[0, 'asc'], [3, 'asc']],
      columnDefs :[
        {
          targets: 0,
          searchable: false
        },
        {
          targets: 3,
          className: 'single line'
        },
        {
          targets: -1,
          orderable: false,
          searchable: false
        },
      ]
    });
    $('input').on( 'keyup change clear', function () {
          table
            .search( this.value )
            .draw();
    } );
    $('.heart.icon').click(function () {
      const project_id = $(this).attr('data-value')
      const url = $(this).attr('data-url')
      var like_button = $(this)
      $.ajax({
        type: 'POST',
        url: url,
        data: {
          'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
          'project_id': project_id
        },
        success: function (response) {
          like_button.toggleClass("outline")
          like_button.toggleClass("red")
          if (like_button.hasClass("red")) {
            like_button.attr('title', 'Remove from favourite')
          } else {
            like_button.attr('title', 'Add to favourite')
          }
          console.log(response.data)
        },
        error: function (response) {
          console.log("error")
        }
      })
    })
  } );
</script>
<div class="ui centered stackable grid container">
  <div class="center aligned sixteen wide column">
    <h2 class="brand-title">{% trans "My Projects" %}</h2>
  </div>
  <table
  id="table"
  class="bg-white"
  data-ajax="ajaxRequest"
  {% comment %} data-check-on-init="true"
  data-mobile-responsive="true" {% endcomment %}
  {% comment %} data-show-columns="true" {% endcomment %}
  data-search="true"
  data-show-refresh="true"
  data-show-columns-toggle-all="true"
  data-show-pagination-switch="true"
  data-show-toggle="true"
  data-id-field="id"
  data-pagination="true"
  data-pagination-h-align="right"
  data-pagination-detail-h-align="left"
  data-pagelist="[5, 10, 25, 50, all]"
  data-pagination-pre-text="<"
  data-pagination-next-text=">"
  data-pagination-parts="['pageSize', 'pageList']"
  {% comment %} data-buttons-toolbar=".buttons-toolbar"
  data-search-selector="#customSearch" {% endcomment %}
  {% comment %} data-search-highlight="true" {% endcomment %}
  data-show-multi-sort="true"
  data-sort-priority='[{"sortName": "liked","sortOrder":"asc"},{"sortName":"date_created","sortOrder":"desc"}]'>
  </table>
  {% csrf_token %}
</div>
{% endblock content %}

{% block javascripts %}
<script>
  var $table = $('#table')
  function ajaxRequest(params){
    $.ajax({
      url: "{% url 'main:project-json-list' %}",
      type: "GET",
      success: function(rs){
        console.log(rs)
        var message = rs.data;
          params.success({
            rows: message
          });
      },
      error: function(rs){
        console.log(rs)
      }
    })
	}
  function likedFormatter(value, row) {
      if (value == '0'){
        return '<i role="button" id="like" class="center aligned ui heart icon red"><i>'
      }else{
        return '<i role="button" id="like" class="center aligned ui heart icon outline"><i>'
      }
  }
  function ticketsFormatter(value, row) {
    return `<h2 class="ui green header">${value}</h2>`
  }
  function managerFormatter(value, row) {
    if (value == {{ request.user.username }}){
      return '<a class="ui small button" href="#">'+
                'Manage User'+
              '</a>'
    }else{
      return '<div class="text">'+
                '<img class="ui avatar image" src="">'+
                '123'+
              '</div>'
    }
  }
  function detailFormatter(value, row) {
  return '<a class="ui small right labeled icon blue button" href="#">'+
            '<i class="right arrow icon"></i>'+
              'Detail'+
          '</a>'
  }
  var likedEvent = {
    'click #like': function (e, value, row, index) {
      $.ajax({
        type: 'POST',
        url: {% url 'main:project-like-unlike' %},
        data: {
          'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
          'project_id': row.id
        },
        success: function (response) {
          const like_button = $("#like")
          like_button.toggleClass("outline")
          like_button.toggleClass("red")
          if (like_button.hasClass("red")) {
            like_button.attr('title', 'Remove from favourite')
          } else {
            like_button.attr('title', 'Add to favourite')
          }
          console.log(response)
        },
        error: function (response) {
          console.log("error")
        }
      })
    }
  }
  function initTable() {
    $table.bootstrapTable({
      columns:[
        {
          field: "id",
          title: "ID",
          visible: false
        },
        {
          field: "liked",
          formatter: likedFormatter,
          searchFormatter: false,
          align: "center",
          halign: "center",
          falign: "center",
          events:likedEvent,
          searchable: false,
          sortable: true
        },
        {
          field: "num_tickets",
          title:"Tickets",
          formatter: ticketsFormatter,
          searchFormatter: false,
          align: "center",
          halign: "center",
          falign: "center",
          sortable: true
        },
        {
          field: "title",
          title:"Title",
          align: "center",
          halign: "center",
          falign: "center",
          sortable: true
        },
        {
          field: "date_created",
          title:"Create Date",
          searchFormatter: false,
          align: "center",
          halign: "center",
          falign: "center",
          sortable: true
        },
        {
          field: "manager",
          title:"Manager",
          {% comment %} formatter: managerFormatter, {% endcomment %}
          searchFormatter: false,
          align: "center",
          halign: "center",
          falign: "center",
          searchable: false
        },
        {
          title:"",
          formatter: detailFormatter,
          align: "center",
          halign: "center",
          falign: "center",
          searchable: false
        }
      ]
    })
  }
  $(function() {
    initTable()
  })
</script>
{% endblock javascripts %}




function filter(search_value, column_list, operator) {
      var filter = search_value.toUpperCase()
      if (operator == 'and') {
        for (i = 0; i < column_list.length, i++) {
          let qs = `td:nth-child(${column})`;
          for (j = 0; j < rows.length; j++) {
            let td = rows[j].querySelector(qs);
            let filter_attr = td.getAttribute("data-filter");
            let text = td.textContent || td.innerText;
            let value = (filter_attr) ? filter_attr : text
            if (value.toUpperCase().indexOf(filter) > -1) {

            };
          };
        };
      };
    };
